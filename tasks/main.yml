---

- name: normalize os
  include_tasks: normalize.yml

- name: establish packages
  become: true
  package:
    name:
      - git
      - "{{ flavor }}"
    state: present
  tags: install

- name: ensure config path presence
  become_user: "{{ ansible_user | default('root') }}"
  become: true
  file:
    path: "{{ flavor_info[flavor]['config']['path'] }}"
    state: directory
  tags: install

- name: establish editor configuration
  become_user: "{{ ansible_user | default('root') }}"
  become: true
  template:
    src: vimrc.j2
    dest: "{{ flavor_info[flavor]['config']['file'] }}"
  register: vimrc
  tags: configure

- name: establish plugin manager   # noqa 401
  become_user: "{{ ansible_user | default('root') }}"
  become: true
  when: plugin_manager in plugin_manager_repo
  git:
    repo: "{{ plugin_manager_repo[plugin_manager] }}"
    dest: "{{ flavor_info[flavor]['config']['path'] }}/bundle/{{ plugin_manager }}"
    update: true
  tags: configure

- when: vimrc.changed
  block:
    - name: load plugins
      become_user: "{{ ansible_user | default('root') }}"
      become: true
      command: "{{ flavor_info[flavor]['command'] }} +PluginInstall +qall"
      changed_when: false
      tags: configure

    - include_tasks: prepare_plugins.yml
      tags: configure
